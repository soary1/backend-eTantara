<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eTantara - Tableau de bord</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/pages.css}">
</head>
<body class="page-dashboard">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="navbar-brand">
                <i class="fas fa-book-reader"></i>
                eTantara
            </a>
            <div class="nav-links">
                <a href="/dashboard" class="active"><i class="fas fa-th-large"></i> Tableau de bord</a>
                <a href="/contenus"><i class="fas fa-book-open"></i> Contenus Culturels</a>
                
                <!-- Section connexion facultative -->
                <div id="authSection">
                    <div id="guestSection" class="guest-section">
                        <button id="showLoginBtn" class="btn btn-login">
                            <i class="fas fa-sign-in-alt"></i> Se connecter
                        </button>
                        <a href="/register" class="btn btn-register">
                            <i class="fas fa-user-plus"></i> S'inscrire
                        </a>
                    </div>
                    
                    <div id="userSection" class="user-section" style="display: none;">
                        <div class="user-stats">
                            <span id="userWelcome" class="user-welcome">
                                <i class="fas fa-user"></i> Bienvenue !
                            </span>
                            <span id="userScore" class="user-score" style="display: none;">
                                <i class="fas fa-star"></i> <span id="scoreValue">0</span> pts
                            </span>
                        </div>
                        <a href="#" id="logoutBtn" class="btn btn-logout">
                            <i class="fas fa-sign-out-alt"></i> Déconnexion
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1>Tongasoa !</h1>
            <p>Mitahiry sy mizara ny lovantsofina maha-Malagasy antsika</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-book"></i>
                    </div>
                </div>
                <div class="stat-value">124</div>
                <div class="stat-label">Histoires explorées</div>
            </div>

            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                </div>
                <div class="stat-value">85%</div>
                <div class="stat-label">Score moyen</div>
            </div>

            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                </div>
                <div class="stat-value">12</div>
                <div class="stat-label">Jours consécutifs</div>
            </div>

            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
                <div class="stat-value">48</div>
                <div class="stat-label">Badges gagnés</div>
            </div>
        </div>

        <!-- Quiz Journalier -->
        <div class="quiz-section">
            <div class="quiz-header">
                <div class="quiz-title">
                    <h2><i class="fas fa-brain"></i> Quiz du Jour</h2>
                </div>
                <div class="quiz-badge">
                    <i class="fas fa-calendar-day"></i> <span id="quizDate">Aujourd'hui</span>
                </div>
            </div>
            
            <div id="quizContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Chargement du quiz...
                </div>
            </div>
            
            <div class="quiz-stats-mini">
                <span><i class="fas fa-trophy"></i> Score: <span id="userScore">0</span> points</span>
                <span><i class="fas fa-fire"></i> Série: <span id="userStreak">0</span> jours</span>
                <span><i class="fas fa-percent"></i> Précision: <span id="userAccuracy">0</span>%</span>
            </div>
        </div>

        <!-- Featured Content with Images -->
        <div class="featured-section">
            <div class="featured-card">
                <div class="featured-image">
                    <span class="featured-badge">Nouveau</span>
                </div>
                <div class="featured-content">
                    <h3>Les contes d'Ibonia</h3>
                    <p>Découvrez l'épopée légendaire du héros malagasy Ibonia et ses aventures extraordinaires.</p>
                    <div class="featured-meta">
                        <span><i class="fas fa-clock"></i> 15 min</span>
                        <span><i class="fas fa-eye"></i> 234 vues</span>
                    </div>
                </div>
            </div>

            <div class="featured-card">
                <div class="featured-image">
                    <span class="featured-badge">Populaire</span>
                </div>
                <div class="featured-content">
                    <h3>Carte interactive</h3>
                    <p>Explorez les régions de Madagascar et leurs richesses culturelles uniques.</p>
                    <div class="featured-meta">
                        <span><i class="fas fa-map-marker-alt"></i> 22 régions</span>
                        <span><i class="fas fa-images"></i> 340 photos</span>
                    </div>
                </div>
            </div>

            <div class="featured-card">
                <div class="featured-image">
                    <span class="featured-badge">Tendance</span>
                </div>
                <div class="featured-content">
                    <h3>Quiz du mois</h3>
                    <p>Testez vos connaissances sur les traditions et l'histoire malagasy.</p>
                    <div class="featured-meta">
                        <span><i class="fas fa-question-circle"></i> 20 questions</span>
                        <span><i class="fas fa-users"></i> 1.2k joueurs</span>
                    </div>
                </div>
            </div>

            <div class="featured-card">
                <div class="featured-image">
                    <span class="featured-badge">Communauté</span>
                </div>
                <div class="featured-content">
                    <h3>Partagez votre histoire</h3>
                    <p>Contribuez à préserver notre patrimoine en partageant vos récits familiaux.</p>
                    <div class="featured-meta">
                        <span><i class="fas fa-heart"></i> 456 contributions</span>
                        <span><i class="fas fa-share-alt"></i> Participer</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid" style="margin-top: 3rem;">
            <!-- Activity Timeline -->
            <div class="activity-card">
                <div class="card-title">
                    <i class="fas fa-history"></i>
                    <h3>Activités récentes</h3>
                </div>

                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <h4>Histoire completée</h4>
                        <p>Les contes de grand-mère Rasoa - Chapitre 3</p>
                        <small>Il y a 2 heures</small>
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <h4>Quiz terminé avec succès</h4>
                        <p>Culture et traditions malagasy - Score: 85%</p>
                        <small>Hier à 14:30</small>
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <h4>Nouveau badge débloqué</h4>
                        <p>Expert en Hira Gasy - Niveau Or</p>
                        <small>Il y a 2 jours</small>
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <h4>Contribution ajoutée</h4>
                        <p>Histoire familiale: Les traditions de l'Imerina</p>
                        <small>Il y a 3 jours</small>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i>
                    <h3>Vos progrès</h3>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <div class="progress-label">
                            <i class="fas fa-book-open"></i>
                            <span>Culture générale</span>
                        </div>
                        <div class="progress-value">85%</div>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" style="width: 85%"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <div class="progress-label">
                            <i class="fas fa-music"></i>
                            <span>Musique traditionnelle</span>
                        </div>
                        <div class="progress-value">72%</div>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" style="width: 72%"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <div class="progress-label">
                            <i class="fas fa-landmark"></i>
                            <span>Histoire de Madagascar</span>
                        </div>
                        <div class="progress-value">90%</div>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" style="width: 90%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p><strong>© 2025 eTantara</strong></p>
            <p>Mitahiry sy mizara ny lovantsofina maha-Malagasy antsika</p>
            <p>Plateforme culturelle malagasy pour préserver et partager notre héritage</p>
        </div>
    </footer>

    <script>
        let currentQuiz = null;
        let selectedAnswer = null;
        let hasAnswered = false;

        // Charger le quiz au chargement de la page
        document.addEventListener('DOMContentLoaded', async function() {
            // Gérer l'authentification
            const token = localStorage.getItem('token');
            await updateUIBasedOnAuth(token);
            setupAuthEventListeners();
            
            // Charger le quiz et les stats
            loadDailyQuiz();
            loadQuizStats();
        });

        // Charger le quiz du jour
        async function loadDailyQuiz() {
            try {
                const response = await fetch('/api/quiz/daily');
                if (response.ok) {
                    currentQuiz = await response.json();
                    displayQuiz(currentQuiz);
                    document.getElementById('quizDate').textContent = formatDate(currentQuiz.date);
                } else {
                    document.getElementById('quizContainer').innerHTML = '<p>Erreur lors du chargement du quiz.</p>';
                }
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('quizContainer').innerHTML = '<p>Erreur lors du chargement du quiz.</p>';
            }
        }

        // Afficher le quiz
        function displayQuiz(quiz) {
            const container = document.getElementById('quizContainer');
            hasAnswered = quiz.dejaParticipe || false;
            selectedAnswer = null;

            // Si l'utilisateur a déjà participé, afficher le résultat
            if (quiz.dejaParticipe && quiz.participationInfo) {
                displayCompletedQuiz(quiz);
                return;
            }

            let html = `
                <div class="quiz-card">
                    <div class="quiz-question">
                        <i class="fas fa-question-circle"></i> ${quiz.question}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span style="background: #e0d0c0; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                            ${quiz.category} • ${quiz.difficulty}
                        </span>
                    </div>
            `;

            if (quiz.type === 'complete') {
                // Quiz à compléter
                const textParts = quiz.text.split('_____');
                html += `
                    <div class="quiz-text">
                        ${textParts[0]}<input type="text" id="quizAnswer" class="quiz-input" placeholder="Complétez ici..." style="display: inline; width: 200px; margin: 0 0.5rem;">${textParts[1] || ''}
                    </div>
                `;
            } else {
                // Quiz à choix multiples
                html += `<div class="quiz-text">${quiz.text}</div>`;
                
                if (quiz.options) {
                    html += '<div class="quiz-options">';
                    quiz.options.forEach((option, index) => {
                        html += `
                            <div class="quiz-option" onclick="selectOption('${option}', this)">
                                ${option}
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            html += `
                    <div class="quiz-actions">
                        <button class="quiz-btn quiz-btn-primary" onclick="submitAnswer()">
                            <i class="fas fa-check"></i> Valider
                        </button>
                        <button class="quiz-btn quiz-btn-secondary" onclick="skipQuiz()">
                            <i class="fas fa-forward"></i> Passer
                        </button>
                    </div>
                    <div id="quizResult" class="quiz-result"></div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Afficher un quiz déjà complété
        function displayCompletedQuiz(quiz) {
            const container = document.getElementById('quizContainer');
            const participation = quiz.participationInfo;
            
            let html = `
                <div class="quiz-card">
                    <div class="quiz-question">
                        <i class="fas fa-check-circle" style="color: #28a745;"></i> Quiz du jour terminé !
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span style="background: #e0d0c0; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                            ${quiz.category} • ${quiz.difficulty}
                        </span>
                    </div>
                    
                    <div class="quiz-text" style="margin-bottom: 1rem;">
                        <strong>Question:</strong> ${quiz.question}<br>
                        ${quiz.text ? `<em>${quiz.text}</em>` : ''}
                    </div>
                    
                    <div style="background: ${participation.estCorrect ? '#d4edda' : '#f8d7da'}; 
                                padding: 1rem; border-radius: 8px; margin-bottom: 1rem;
                                border-left: 4px solid ${participation.estCorrect ? '#28a745' : '#dc3545'};">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">
                            ${participation.estCorrect ? 
                                '<i class="fas fa-check"></i> Bonne réponse !' : 
                                '<i class="fas fa-times"></i> Réponse incorrecte'}
                        </div>
                        <div><strong>Votre réponse:</strong> ${participation.reponseDonnee}</div>
                        <div><strong>Bonne réponse:</strong> ${quiz.correctAnswer}</div>
                        <div><strong>Points gagnés:</strong> ${participation.pointsObtenus}</div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong>Explication:</strong><br>
                        ${quiz.explanation}
                    </div>
                    
                    <div style="text-align: center; color: #666;">
                        <i class="fas fa-calendar-day"></i> Revenez demain pour un nouveau quiz !
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Masquer le résultat s'il était affiché
            const resultDiv = document.getElementById('quizResult');
            if (resultDiv) {
                resultDiv.style.display = 'none';
            }
        }

        // Sélectionner une option
        function selectOption(answer, element) {
            if (hasAnswered) return;

            // Retirer la sélection précédente
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Sélectionner la nouvelle option
            element.classList.add('selected');
            selectedAnswer = answer;
        }

        // Soumettre la réponse
        async function submitAnswer() {
            if (hasAnswered) return;

            let answer;
            if (currentQuiz.type === 'complete') {
                answer = document.getElementById('quizAnswer').value.trim();
            } else {
                answer = selectedAnswer;
            }

            if (!answer) {
                alert('Veuillez donner une réponse avant de valider.');
                return;
            }

            hasAnswered = true;
            const token = localStorage.getItem('token');

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Ajouter le token d'authentification si l'utilisateur est connecté
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/quiz/check', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        questionId: currentQuiz.id,
                        answer: answer
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    await showResult(result);
                    
                    // Si la réponse est correcte et l'utilisateur est connecté, recharger ses stats
                    if (result.correct && token) {
                        await loadUserStats(token);
                        showSuccessMessage(`Bravo ! Vous avez gagné ${result.points} points !`);
                    }
                } else {
                    const error = await response.json();
                    if (response.status === 400 && error.error === "Vous avez déjà participé au quiz d'aujourd'hui") {
                        showErrorMessage(error.message || "Vous avez déjà participé au quiz d'aujourd'hui !");
                        // Recharger le quiz pour afficher l'état "déjà participé"
                        loadDailyQuiz();
                    } else if (response.status === 401) {
                        showErrorMessage("Vous devez être connecté pour participer au quiz.");
                    } else {
                        showErrorMessage(error.error || 'Erreur lors de la vérification de la réponse.');
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la vérification de la réponse.');
            }
        }

        // Afficher le résultat
        async function showResult(result) {
            const resultDiv = document.getElementById('quizResult');
            resultDiv.style.display = 'block';
            
            if (result.correct) {
                resultDiv.className = 'quiz-result correct';
                resultDiv.innerHTML = `
                    <strong><i class="fas fa-check-circle"></i> Correct !</strong><br>
                    <em>${result.explanation}</em><br>
                    <small>+${result.points} points</small>
                `;
            } else {
                resultDiv.className = 'quiz-result incorrect';
                resultDiv.innerHTML = `
                    <strong><i class="fas fa-times-circle"></i> Incorrect.</strong><br>
                    La bonne réponse était : <strong>${result.correctAnswer}</strong><br>
                    <em>${result.explanation}</em>
                `;
            }

            // Désactiver les options
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.style.opacity = '0.7';
            });

            const answerInput = document.getElementById('quizAnswer');
            if (answerInput) {
                answerInput.disabled = true;
            }

            // Mettre à jour les stats (simulation)
            updateQuizStats(result.correct, result.points);
        }

        // Passer le quiz
        function skipQuiz() {
            if (confirm('Êtes-vous sûr de vouloir passer ce quiz ?')) {
                loadDailyQuiz(); // Recharger un nouveau quiz (en réalité, ce serait le même)
            }
        }

        // Charger les statistiques du quiz
        async function loadQuizStats() {
            try {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                
                // Ajouter le token d'authentification si disponible
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/quiz/stats', {
                    method: 'GET',
                    headers: headers
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    
                    // Mettre à jour les éléments s'ils existent
                    const scoreElement = document.getElementById('userScore');
                    const streakElement = document.getElementById('userStreak');
                    const accuracyElement = document.getElementById('userAccuracy');
                    
                    if (scoreElement) scoreElement.textContent = stats.totalPoints || 0;
                    if (streakElement) streakElement.textContent = stats.streak || 0;
                    if (accuracyElement) accuracyElement.textContent = stats.accuracy || 0;
                    
                    console.log('✅ Stats quiz chargées:', stats);
                } else {
                    console.warn('⚠️ Impossible de charger les stats quiz');
                }
            } catch (error) {
                console.error('❌ Erreur lors du chargement des stats quiz:', error);
            }
        }

        // Mettre à jour les stats en rechargeant depuis l'API
        async function updateQuizStats(isCorrect, points) {
            // Si l'utilisateur est connecté et a eu une bonne réponse, recharger les vraies données
            const token = localStorage.getItem('token');
            if (isCorrect && token) {
                try {
                    // Recharger les stats utilisateur (score affiché dans la navigation)
                    await loadUserStats(token);
                    
                    // Recharger les stats de quiz
                    await loadQuizStats();
                    
                    console.log('✅ Stats mises à jour avec succès');
                } catch (error) {
                    console.error('❌ Erreur lors de la mise à jour des stats:', error);
                    // Fallback : mise à jour locale en cas d'erreur
                    updateQuizStatsLocal(isCorrect, points);
                }
            } else {
                // Mise à jour locale pour les utilisateurs non connectés ou mauvaises réponses
                updateQuizStatsLocal(isCorrect, points);
            }
        }

        // Mise à jour locale des stats (fallback)
        function updateQuizStatsLocal(isCorrect, points) {
            try {
                const currentScore = parseInt(document.getElementById('userScore')?.textContent) || 0;
                const currentStreak = parseInt(document.getElementById('userStreak')?.textContent) || 0;
                const currentAccuracy = parseInt(document.getElementById('userAccuracy')?.textContent) || 0;

                // Mettre à jour le score dans la navigation si l'élément existe
                const scoreElement = document.getElementById('scoreValue');
                if (scoreElement) {
                    scoreElement.textContent = currentScore + points;
                }

                // Mettre à jour les stats du quiz si les éléments existent
                const streakElement = document.getElementById('userStreak');
                if (streakElement && isCorrect) {
                    streakElement.textContent = currentStreak + 1;
                }

                const accuracyElement = document.getElementById('userAccuracy');
                if (accuracyElement) {
                    const newAccuracy = isCorrect ? Math.min(100, currentAccuracy + 5) : Math.max(0, currentAccuracy - 2);
                    accuracyElement.textContent = newAccuracy;
                }
            } catch (error) {
                console.error('Erreur lors de la mise à jour locale des stats:', error);
            }
        }

        // Formater la date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('fr-FR', options);
        }

        // Animation des barres de progression au chargement
        window.addEventListener('load', () => {
            setTimeout(() => {
                const progressBars = document.querySelectorAll('.progress-bar');
                progressBars.forEach(bar => {
                    const width = bar.style.width;
                    bar.style.width = '0';
                    setTimeout(() => {
                        bar.style.width = width;
                    }, 100);
                });
            }, 300);
        });

        // Animation des cartes au scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.featured-card, .stat-card').forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.6s ease';
            observer.observe(card);
        });

        // ===== FONCTIONS D'AUTHENTIFICATION =====

        // Mettre à jour l'interface selon l'état de connexion
        async function updateUIBasedOnAuth(token) {
            const guestSection = document.getElementById('guestSection');
            const userSection = document.getElementById('userSection');
            const userWelcome = document.getElementById('userWelcome');
            const userScore = document.getElementById('userScore');
            const scoreValue = document.getElementById('scoreValue');
            
            if (token) {
                // Utilisateur connecté
                guestSection.style.display = 'none';
                userSection.style.display = 'flex';
                
                // Récupérer les infos utilisateur depuis le token
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const username = payload.sub ? payload.sub.split('@')[0] : 'Utilisateur';
                    userWelcome.innerHTML = `<i class="fas fa-user"></i> Bonjour ${username} !`;
                    
                    // Charger les vraies statistiques de l'utilisateur
                    await loadUserStats(token);
                } catch (e) {
                    userWelcome.innerHTML = `<i class="fas fa-user"></i> Bonjour !`;
                    userScore.style.display = 'none';
                }
            } else {
                // Utilisateur non connecté
                guestSection.style.display = 'flex';
                userSection.style.display = 'none';
                userScore.style.display = 'none';
            }
        }

        // Charger les statistiques de l'utilisateur connecté
        async function loadUserStats(token) {
            try {
                const response = await fetch('/api/user/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    displayUserStats(stats);
                } else {
                    console.log('Impossible de charger les statistiques utilisateur');
                    document.getElementById('userScore').style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
                document.getElementById('userScore').style.display = 'none';
            }
        }

        // Afficher les statistiques de l'utilisateur
        function displayUserStats(stats) {
            const userScore = document.getElementById('userScore');
            const scoreValue = document.getElementById('scoreValue');
            
            if (stats.score !== undefined) {
                if (stats.score > 0) {
                    scoreValue.textContent = stats.score;
                    userScore.style.display = 'flex';
                } else {
                    scoreValue.textContent = '0';
                    userScore.style.display = 'flex';
                    userScore.title = 'Commencez à jouer pour gagner des points !';
                }
                
                // Optionnel: ajouter le niveau
                if (stats.niveau) {
                    userScore.title = `Niveau: ${stats.niveau}`;
                }
            } else {
                userScore.style.display = 'none';
            }
        }

        // Configurer les écouteurs d'authentification
        function setupAuthEventListeners() {
            // Modal connexion
            const showLoginBtn = document.getElementById('showLoginBtn');
            const closeLoginModal = document.getElementById('closeLoginModal');
            const continueAsGuest = document.getElementById('continueAsGuest');
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');

            if (showLoginBtn) showLoginBtn.addEventListener('click', showLoginModal);
            if (closeLoginModal) closeLoginModal.addEventListener('click', closeLoginModalFunc);
            if (continueAsGuest) continueAsGuest.addEventListener('click', closeLoginModalFunc);
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            
            // Gestion des clics sur les modals
            window.addEventListener('click', function(event) {
                const loginModal = document.getElementById('loginModal');
                if (event.target === loginModal) {
                    closeLoginModalFunc();
                }
            });
            
            // Déconnexion
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    updateUIBasedOnAuth(null);
                    showSuccessMessage('Vous avez été déconnecté avec succès !');
                });
            }
        }

        // Afficher le modal de connexion
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        // Fermer le modal de connexion
        function closeLoginModalFunc() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // Gérer la connexion
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.token);
                    await updateUIBasedOnAuth(data.token);
                    closeLoginModalFunc();
                    showSuccessMessage('Connexion réussie ! Bienvenue sur eTantara.');
                } else {
                    const error = await response.json();
                    showErrorMessage(error.message || 'Erreur de connexion');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showErrorMessage('Erreur de connexion. Vérifiez votre connexion internet.');
            }
        }

        // Afficher un message de succès
        function showSuccessMessage(message) {
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1100;
                font-weight: 500;
            `;
            alert.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) alert.remove();
            }, 3000);
        }

        // Afficher un message d'erreur
        function showErrorMessage(message) {
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1100;
                font-weight: 500;
            `;
            alert.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) alert.remove();
            }, 4000);
        }
    </script>

    <!-- Modal de connexion -->
    <div id="loginModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Connexion facultative</h2>
                <span class="close" id="closeLoginModal">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: #666; text-align: center;">
                    Se connecter vous permet de sauvegarder vos préférences et de suivre vos activités.
                </p>
                
                <form id="loginForm">
                    <div style="margin-bottom: 1rem;">
                        <label for="loginEmail" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email:</label>
                        <input type="email" id="loginEmail" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="loginPassword" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mot de passe:</label>
                        <input type="password" id="loginPassword" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        <i class="fas fa-sign-in-alt"></i> Se connecter
                    </button>
                </form>
                
                <div style="text-align: center;">
                    <p style="color: #666; margin-bottom: 0.5rem;">Pas encore de compte ?</p>
                    <a href="/register" class="btn btn-register" style="display: inline-block;">
                        <i class="fas fa-user-plus"></i> Créer un compte
                    </a>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; text-align: center;">
                    <button id="continueAsGuest" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Continuer sans se connecter
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
